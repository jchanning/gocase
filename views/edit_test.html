{{define "edit_test"}}
<div class="container mx-auto py-8 px-4">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Edit Test: {{.Test.Title}}</h1>
        <div class="space-x-2">
            {{if not .Test.Published}}
            <button onclick="publishTest({{.Test.ID}})" 
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Publish Test
            </button>
            {{else}}
            <button onclick="unpublishTest({{.Test.ID}})" 
                class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Unpublish Test
            </button>
            {{end}}
            <a href="/teacher/test/{{.Test.ID}}/preview" target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-block">
                Preview
            </a>
            <button onclick="deleteTest({{.Test.ID}})" 
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                Delete
            </button>
        </div>
    </div>
    
    <form method="POST" action="/teacher/test/{{.Test.ID}}/update" class="bg-white rounded-lg shadow p-6">
        <!-- Test Information -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Information</h2>
            
            <div class="mb-4">
                <label for="title" class="block text-sm font-medium text-gray-700">Test Title*</label>
                <input type="text" id="title" name="title" value="{{.Test.Title}}" required 
                    class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label for="description" class="block text-sm font-medium text-gray-700">Description*</label>
                <textarea id="description" name="description" rows="3" required
                    class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">{{.Test.Description}}</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="exam_standard" class="block text-sm font-medium text-gray-700">Exam Standard*</label>
                    <select id="exam_standard" name="exam_standard" required
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">
                        <option value="Primary" {{if eq .Test.ExamStandard "Primary"}}selected{{end}}>Primary</option>
                        <option value="Secondary" {{if eq .Test.ExamStandard "Secondary"}}selected{{end}}>Secondary</option>
                        <option value="GCSE" {{if eq .Test.ExamStandard "GCSE"}}selected{{end}}>GCSE</option>
                        <option value="A-Level" {{if eq .Test.ExamStandard "A-Level"}}selected{{end}}>A-Level</option>
                    </select>
                </div>
                
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700">Difficulty*</label>
                    <select id="difficulty" name="difficulty" required
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">
                        <option value="Easy" {{if eq .Test.Difficulty "Easy"}}selected{{end}}>Easy</option>
                        <option value="Medium" {{if eq .Test.Difficulty "Medium"}}selected{{end}}>Medium</option>
                        <option value="Hard" {{if eq .Test.Difficulty "Hard"}}selected{{end}}>Hard</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                    <label for="time_limit_minutes" class="block text-sm font-medium text-gray-700">Time Limit (minutes)*</label>
                    <input type="number" id="time_limit_minutes" name="time_limit_minutes" 
                        value="{{.Test.TimeLimitMinutes}}" min="1" required
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">
                </div>
                
                <div>
                    <label for="passing_score" class="block text-sm font-medium text-gray-700">Passing Score (%)*</label>
                    <input type="number" id="passing_score" name="passing_score" 
                        value="{{.Test.PassingScore}}" min="0" max="100" required
                        class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2">
                </div>
            </div>
        </div>
        
        <!-- Questions Section -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Questions ({{len .Test.Questions}})</h2>
            
            {{range .Test.Questions}}
            <div class="bg-gray-50 rounded-lg p-4 mb-4 border-l-4 border-blue-500">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">Question {{.QuestionOrder}}</h3>
                </div>
                
                <div class="bg-white p-3 rounded border border-gray-200">
                    <p class="text-sm font-medium text-gray-700 mb-2">Question Text:</p>
                    <p class="text-gray-600 mb-3">{{.QuestionText}}</p>
                    
                    {{if .ImageURL}}
                    <div class="mb-3">
                        <img src="{{.ImageURL}}" alt="Question image" class="max-h-32 rounded">
                    </div>
                    {{end}}
                    
                    <p class="text-sm font-medium text-gray-700 mb-2">Answer Options:</p>
                    <ul class="space-y-2">
                        {{range .Options}}
                        <li class="text-gray-600">
                            {{if .IsCorrect}}
                            <span class="inline-block w-5 h-5 bg-green-200 rounded-full text-center text-green-700 text-xs">âœ“</span>
                            {{else}}
                            <span class="inline-block w-5 h-5 bg-gray-200 rounded-full"></span>
                            {{end}}
                            {{.OptionText}}
                        </li>
                        {{end}}
                    </ul>
                </div>
            </div>
            {{end}}
        </div>
        
        <!-- Form Actions -->
        <div class="flex gap-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                Save Changes
            </button>
            <a href="/teacher/dashboard" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded inline-block">
                Back to Dashboard
            </a>
        </div>
    </form>
</div>

<script>
function publishTest(testId) {
    if (confirm('Are you sure you want to publish this test? Students will be able to take it.')) {
        fetch(`/teacher/test/${testId}/publish`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Test published successfully!');
                location.reload();
            } else {
                alert('Error publishing test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function unpublishTest(testId) {
    if (confirm('Are you sure you want to unpublish this test? Students will no longer see it.')) {
        fetch(`/teacher/test/${testId}/unpublish`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Test unpublished successfully!');
                location.reload();
            } else {
                alert('Error unpublishing test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function deleteTest(testId) {
    if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        fetch(`/teacher/test/${testId}/delete`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Test deleted successfully!');
                window.location.href = '/teacher/dashboard';
            } else {
                alert('Error deleting test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
</script>
{{end}}
