{{define "content"}}
<div class="max-w-4xl mx-auto">
    <!-- Test Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{{.Test.Title}}</h2>
                <p class="text-gray-600 mt-1">{{.Test.Description}}</p>
                <div class="flex gap-4 mt-3 text-sm">
                    <span class="text-gray-700">üìö {{.Test.Subject.Name}}</span>
                    <span class="text-gray-700">‚è±Ô∏è {{.Test.TimeLimitMinutes}} minutes</span>
                    <span class="px-2 py-1 rounded {{if eq .Test.Difficulty "Easy"}}bg-green-100 text-green-800
                        {{else if eq .Test.Difficulty "Medium"}}bg-yellow-100 text-yellow-800
                        {{else}}bg-red-100 text-red-800{{end}}">
                        {{.Test.Difficulty}}
                    </span>
                </div>
            </div>
            <div class="text-right">
                <div id="timer" class="text-3xl font-bold text-blue-600">--:--</div>
                <p class="text-xs text-gray-500">Time Remaining</p>
            </div>
        </div>
    </div>

    <!-- Questions -->
    <form id="testForm" method="POST" action="/test/submit">
        <input type="hidden" name="attempt_id" value="{{.Attempt.ID}}">
        
        {{range $index, $question := .Test.Questions}}
        <div class="bg-white rounded-lg shadow-md p-6 mb-4">
            <div class="flex items-start mb-4">
                <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">
                    {{add $index 1}}
                </span>
                <div class="flex-grow">
                    <p class="text-lg font-medium text-gray-800">{{$question.QuestionText}}</p>
                    {{if $question.ImageURL}}
                    <img src="{{$question.ImageURL}}" alt="Question image" class="mt-3 max-w-full rounded border">
                    {{end}}
                </div>
                <span class="text-sm text-gray-500 ml-2">{{$question.Points}} pt{{if ne $question.Points 1}}s{{end}}</span>
            </div>
            
            <div class="space-y-2 ml-11">
                {{range $optIndex, $option := $question.Options}}
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition duration-200
                    {{if index $.Answered $question.ID}}{{if eq (index $.Answered $question.ID) $option.ID}}border-blue-500 bg-blue-50{{end}}{{end}}">
                    <input type="radio" 
                           name="question_{{$question.ID}}" 
                           value="{{$option.ID}}"
                           {{if index $.Answered $question.ID}}{{if eq (index $.Answered $question.ID) $option.ID}}checked{{end}}{{end}}
                           data-question-id="{{$question.ID}}"
                           data-attempt-id="{{$.Attempt.ID}}"
                           class="mr-3 w-4 h-4 text-blue-600">
                    <span class="flex-grow">{{$option.OptionText}}</span>
                </label>
                {{end}}
            </div>
        </div>
        {{end}}
        
        <div class="bg-white rounded-lg shadow-md p-6 sticky bottom-4">
            <div class="flex justify-between items-center">
                <p class="text-gray-600">
                    <span id="answeredCount">0</span> of {{len .Test.Questions}} questions answered
                </p>
                <button type="submit" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200">
                    Submit Test
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Timer
let timeLimit = {{.TimeLimit}};
let timeLeft = timeLimit;
const timerEl = document.getElementById('timer');

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 60) {
        timerEl.classList.add('text-red-600');
        timerEl.classList.remove('text-blue-600');
    }
    
    if (timeLeft <= 0) {
        document.getElementById('testForm').submit();
    } else {
        timeLeft--;
    }
}

setInterval(updateTimer, 1000);
updateTimer();

// Auto-save answers
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const attemptId = this.dataset.attemptId;
        const questionId = this.dataset.questionId;
        const optionId = this.value;
        
        fetch('/test/answer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                attempt_id: parseInt(attemptId),
                question_id: parseInt(questionId),
                option_id: parseInt(optionId)
            })
        });
        
        updateAnsweredCount();
    });
});

function updateAnsweredCount() {
    const answered = document.querySelectorAll('input[type="radio"]:checked').length;
    document.getElementById('answeredCount').textContent = answered;
}

updateAnsweredCount();
</script>
{{end}}
